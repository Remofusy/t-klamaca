<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>OynaKral - Final Fix</title>
    <style>
        *{box-sizing:border-box; outline: none;}
        body{margin:0;height:100vh;background:#0e0016;color:#fff;font-family:sans-serif;overflow:hidden;}
        .hidden{display:none!important}
        .center{display:flex;justify-content:center;align-items:center;height: 100vh;}
        .card{background:rgba(25, 0, 50, 0.95);padding:30px;border-radius:18px;width:400px;text-align:center;border:1px solid #7a3cff;box-shadow: 0 0 15px #7a3cff55;}
        input,button{width:100%;padding:10px;margin-top:10px;border-radius:8px;border:none;}
        button{background:#7a3cff;color:#fff;font-weight:bold;cursor:pointer;}
        button:hover{background:#9b6dff;}
        
        #gameRoot, #voleybolRoot {height:100vh; display:grid; grid-template-columns:220px 1fr 300px;}
        #rplaceRoot {height:100vh; display:grid; grid-template-columns:220px 1fr 300px; grid-template-rows:1fr 75px;}
        .sidebar {background:#12001f; padding:15px; border-right:1px solid #333; display:flex; flex-direction:column; gap:10px;}
        .chat-sidebar {background:#0a0014; padding:15px; border-left:1px solid #333; display:flex; flex-direction:column;}
        .chat-msgs {flex:1; overflow-y:auto; background:rgba(0,0,0,0.3); border-radius:8px; padding:10px; font-size:13px; margin-bottom:10px;}

        #rCenter {background:#1a1a1a; overflow:auto; position:relative;}
        #canvasWrap {background:#fff; width:2400px; height:2400px;}
        #canvas {display:grid; grid-template-columns:repeat(200, 12px); width:2400px; height:2400px;}
        .pixel {width:12px; height:12px; border:0.1px solid #eee; background:#fff;}
        #rBottom {grid-column:1/4; background:#12001f; border-top:2px solid #7a3cff; display:flex; align-items:center; justify-content:center; gap:30px;}
        
        .popup{position:fixed; inset:0; background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:10000;}
        .kick-btn {background:#ff3c3c; padding:2px 6px; font-size:11px; border-radius:4px; margin-left:8px; width:auto; cursor:pointer;}
        #vCanvas {background:linear-gradient(#1a002b, #3e1e5e); border-bottom:8px solid #2ecc71; border-radius:10px;}
    </style>
</head>
<body>

<div class="center" id="authDiv"><div class="card"><h1>ğŸ‘‘ OynaKral</h1><input id="username" placeholder="KullanÄ±cÄ± AdÄ±"><input id="password" type="password" placeholder="Åifre"><button id="loginBtn">GiriÅŸ Yap</button><button id="registerBtn" style="background:#444">KayÄ±t Ol</button></div></div>

<div class="center hidden" id="gameSelect">
    <div class="card">
        <h2>ğŸ® Oyun SeÃ§</h2>
        <button id="btnC">ğŸ–±ï¸ TÄ±klamaca</button>
        <button id="btnR">ğŸ¨ r/place</button>
        <button id="btnV">ğŸ Voleybol</button>
        <button id="logoutBtn" style="background:#cc2b2b; margin-top:20px;">Ã‡Ä±kÄ±ÅŸ Yap</button>
    </div>
</div>

<div id="gameRoot" class="hidden">
    <div class="sidebar">
        <button onclick="document.getElementById('marketPop').style.display='flex'">ğŸ›’ Market</button>
        <button onclick="document.getElementById('casinoPop').style.display='flex'">ğŸ° Casino</button>
        <button class="backMenu">â¬… MenÃ¼</button>
    </div>
    <div class="center"><div class="card"><h2 id="scoreDisp">AltÄ±n: 0</h2><h3 id="powerDisp">GÃ¼Ã§: 1</h3><button id="clickBtn" style="height:120px; font-size:40px;">ğŸ–±ï¸</button></div></div>
    <div class="chat-sidebar"><h3>ğŸ† SÄ±ralama</h3><ul id="board" style="padding:0; list-style:none; color:#3cff7a; font-size:14px; margin-bottom:10px;"></ul><div class="chat-msgs" id="cMsgs"></div><input id="cIn" placeholder="Mesaj..."><button id="cSend">GÃ¶nder</button></div>
</div>

<div id="rplaceRoot" class="hidden">
    <div class="sidebar"><button class="backMenu">â¬… MenÃ¼</button><div style="color:#7a3cff; font-weight:bold;">ğŸŸ¢ Aktif: <span id="rCount">0</span></div><div id="onlineList"></div></div>
    <div id="rCenter"><div id="canvasWrap"><div id="canvas"></div></div></div>
    <div class="chat-sidebar"><h3>ğŸ’¬ Chat</h3><div class="chat-msgs" id="rMsgs"></div><input id="rIn" placeholder="Mesaj..."><button id="rSend">GÃ¶nder</button></div>
    <div id="rBottom"><input type="color" id="color" value="#ff0000" style="width:30px; height:30px;"><div style="font-size:18px;">ğŸ¨ Boya: <span id="paintText">30</span>/30</div></div>
</div>

<div id="voleybolRoot" class="hidden">
    <div class="sidebar"><button class="backMenu">â¬… MenÃ¼</button><div id="vLobby"><button id="vCreate">Oda Kur</button><input id="vJoinCode" placeholder="Kod"><button id="vJoin">KatÄ±l</button></div><div id="vInfo" class="hidden"><h3 id="vDispCode">-</h3><div id="vPlayerList"></div><button id="vStart" class="hidden" style="background:#28a745">BAÅLAT</button><h2 id="vScore">0 - 0</h2></div></div>
    <div class="center"><canvas id="vCanvas" width="800" height="400" class="hidden"></canvas></div>
    <div class="chat-sidebar hidden" id="vChatSide"><h3>ğŸ’¬ Oda Chat</h3><div class="chat-msgs" id="vMsgs"></div><input id="vIn" placeholder="Mesaj..."><button id="vSend">GÃ¶nder</button></div>
</div>

<div id="marketPop" class="popup"><div class="card"><h3>ğŸ›’ Market</h3><p id="marketInfo"></p><button id="buyPowerBtn">GELÄ°ÅTÄ°R</button><button onclick="document.getElementById('marketPop').style.display='none'">Kapat</button></div></div>
<div id="casinoPop" class="popup"><div class="card"><h3>ğŸ° YazÄ± Tura</h3><input id="bet" type="number" placeholder="Bahis"><button id="btnYazi">YAZI</button><button id="btnTura">TURA</button><p id="coinInfo"></p><button onclick="document.getElementById('casinoPop').style.display='none'">Kapat</button></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth,signInWithEmailAndPassword,createUserWithEmailAndPassword,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase,ref,set,push,onValue,runTransaction,get,remove,update,onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const config={apiKey:"AIzaSyCGUe_LPKRAVz1IoqMDn-8ie9RWCrVRQLs",authDomain:"click-game-2de2f.firebaseapp.com",databaseURL:"https://click-game-2de2f-default-rtdb.firebaseio.com"};
const app=initializeApp(config); const auth=getAuth(app); const db=getDatabase(app);

let user=null, userData=null, curRoom=null, isHost=false, roomData=null;

/* --- AUTH & GLOBAL --- */
onAuthStateChanged(auth, u => {
    if(!u) { authDiv.classList.remove("hidden"); return; }
    user=u; authDiv.classList.add("hidden"); gameSelect.classList.remove("hidden");
    onValue(ref(db,"users/"+u.uid), s => {
        userData=s.val(); if(!userData) return;
        if(userData.kicked) { update(ref(db,"users/"+user.uid),{kicked:false}); location.reload(); }
        scoreDisp.innerText="AltÄ±n: "+(userData.score || 0);
        powerDisp.innerText="GÃ¼Ã§: "+(userData.power || 1);
        paintText.innerText=userData.paint||0;
        marketInfo.innerText=`GÃ¼Ã§ +1 | Fiyat: ${userData.price || 100}`;
    });
});
loginBtn.onclick=()=>signInWithEmailAndPassword(auth,username.value+"@oynakral.com",password.value).catch(e=>alert("Hata: "+e.message));
registerBtn.onclick=async()=>{
    const n=username.value, p=password.value;
    const c=await createUserWithEmailAndPassword(auth,n+"@oynakral.com",p);
    await set(ref(db,"users/"+c.user.uid),{username:n,score:0,power:1,price:100,paint:30,kicked:false});
};
logoutBtn.onclick=()=>signOut(auth);
document.querySelectorAll(".backMenu").forEach(b=>b.onclick=()=>location.reload());

/* --- TIKLAMACA --- */
clickBtn.onclick=()=>runTransaction(ref(db,"users/"+user.uid),d=>{if(d){d.score=(d.score||0)+(d.power||1);}return d});
buyPowerBtn.onclick=()=>{
    runTransaction(ref(db,"users/"+user.uid),d=>{
        if(!d) return d;
        let p = d.price || 100;
        if((d.score || 0) >= p){ d.score -= p; d.power = (d.power || 1) + 1; d.price = Math.floor(p * 1.3); }
        else { alert("Yetersiz AltÄ±n!"); }
        return d;
    });
};
const playCoin=(choice)=>{
    const b = parseInt(bet.value); if(!b || b<=0) return;
    runTransaction(ref(db,"users/"+user.uid),d=>{
        if(!d || (d.score||0)<b) return d;
        d.score -= b; const res = Math.random() < 0.5 ? "yazi" : "tura";
        if(res === choice){ d.score += b * 2; coinInfo.innerText="KAZANDIN! SonuÃ§: "+res.toUpperCase(); }
        else { coinInfo.innerText="KAYBETTÄ°N! SonuÃ§: "+res.toUpperCase(); }
        return d;
    });
};
btnYazi.onclick=()=>playCoin("yazi"); btnTura.onclick=()=>playCoin("tura");

onValue(ref(db,"users"), s => {
    const d=s.val(); if(!d) return;
    const arr = Object.values(d).sort((a,b)=>b.score-a.score).slice(0,5);
    board.innerHTML = arr.map(u=>`<li>${u.username}: ${u.score}</li>`).join("");
});

/* --- R/PLACE (BOYAMA VE LÄ°STE FÄ°X) --- */
const cvs=document.getElementById("canvas");
for(let i=0; i<40000; i++){
    const p=document.createElement("div"); p.className="pixel";
    p.onclick=()=>{ 
        if(userData.paint > 0){
            runTransaction(ref(db,"users/"+user.uid+"/paint"), pt => (pt || 0) - 1);
            set(ref(db,"rplace/pixels/"+i), color.value);
        } else { alert("Boyan bitti! Bekle doluyor..."); }
    };
    cvs.appendChild(p);
}
onValue(ref(db,"rplace/pixels"), s => {
    const d=s.val(); if(!d) return;
    Object.keys(d).forEach(k => { if(cvs.children[k]) cvs.children[k].style.background = d[k]; });
});

function trackRplace(){
    const oRef=ref(db,"rplace/online/"+user.uid);
    set(oRef,{name:userData.username, id:user.uid}); onDisconnect(oRef).remove();
    onValue(ref(db,"rplace/online"), s => {
        const d=s.val()||{}; const ks=Object.keys(d);
        let count = 0; onlineList.innerHTML="";
        ks.forEach(k=>{
            const p=d[k];
            if(p.name && p.name !== "undefined"){
                count++;
                let kBtn=(userData.username==="remobaba" && p.id!==user.uid)?`<button class="kick-btn" onclick="window.kickPlayer('${p.id}')">AT</button>`:"";
                onlineList.innerHTML += `<div style="margin-bottom:5px">ğŸ‘¤ ${p.name} ${kBtn}</div>`;
            }
        });
        rCount.innerText = count;
    });
}
window.kickPlayer=(tid)=>update(ref(db,"users/"+tid),{kicked:true});

/* --- CHAT SÄ°STEMÄ° (TIKRÄ°R FIX) --- */
function syncChat(el, path){
    onValue(ref(db,path), s => {
        el.innerHTML=""; const d=s.val(); if(!d) return;
        Object.values(d).forEach(m => el.innerHTML += `<div><b>${m.u}:</b> ${m.t}</div>`);
        el.scrollTop = el.scrollHeight;
    });
}
function chatSend(inp, path){
    const msg = inp.value; if(!msg) return;
    if(msg==="/temizle" && userData.username==="remobaba"){ remove(ref(db,path)); inp.value=""; return; }
    push(ref(db,path), {u:userData.username, t:msg}); inp.value="";
}
cSend.onclick=()=>chatSend(cIn, "chat/tik");
rSend.onclick=()=>chatSend(rIn, "chat/rpl");
vSend.onclick=()=>chatSend(vIn, `vchat/${curRoom}`);
syncChat(cMsgs, "chat/tik"); syncChat(rMsgs, "chat/rpl");

/* --- VOLEYBOL (TEMASSIZ HAREKET FIX) --- */
const vCtx=vCanvas.getContext("2d");
let vKeys={}; window.onkeydown=e=>vKeys[e.code]=true; window.onkeyup=e=>vKeys[e.code]=false;
let vVy=0, vOnGround=true;

vCreate.onclick=()=>{
    const rid=Math.floor(1000+Math.random()*9000); curRoom=rid; isHost=true;
    set(ref(db,`rooms/${rid}`),{host:userData.username, status:"waiting", p1x:150, p1y:380, p2x:650, p2y:380, bx:400, by:180, bvx:0, bvy:0, s1:0, s2:0});
    vInit(rid);
};
vJoin.onclick=()=>{
    const rid=vJoinCode.value; get(ref(db,`rooms/${rid}`)).then(s=>{
        if(s.exists() && !s.val().guest){ curRoom=rid; isHost=false; update(ref(db,`rooms/${rid}`),{guest:userData.username}); vInit(rid); }
    });
};
function vInit(rid){
    vLobby.classList.add("hidden"); vInfo.classList.remove("hidden"); vCanvas.classList.remove("hidden"); vChatSide.classList.remove("hidden");
    vDispCode.innerText="ODA: "+rid; syncChat(vMsgs, `vchat/${rid}`);
    onValue(ref(db,`rooms/${rid}`), s => {
        roomData=s.val(); if(!roomData) return;
        if(roomData.status==="playing"){ vStart.classList.add("hidden"); vRender(roomData); }
        else{ vPlayerList.innerHTML=`${roomData.host} vs ${roomData.guest||'?'}`; if(isHost&&roomData.guest)vStart.classList.remove("hidden"); }
        vScore.innerText=`${roomData.s1} - ${roomData.s2}`;
    });
}
vStart.onclick=()=>update(ref(db,`rooms/${curRoom}`),{status:"playing"});

setInterval(()=>{
    if(!curRoom || !roomData || roomData.status!=="playing") return;
    let mx=isHost?roomData.p1x:roomData.p2x, my=isHost?roomData.p1y:roomData.p2y;
    if(vKeys['KeyA']) mx-=12; if(vKeys['KeyD']) mx+=12;
    if(vKeys['KeyW'] && vOnGround){ vVy=-16; vOnGround=false; }
    if(!vOnGround){ vVy+=0.8; my+=vVy; if(my>=380){my=380; vVy=0; vOnGround=true;} }
    if(isHost){ if(mx<40)mx=40; if(mx>365)mx=365; } else { if(mx<435)mx=435; if(mx>760)mx=760; }

    if(isHost){
        let nbx=roomData.bx+roomData.bvx, nby=roomData.by+roomData.bvy, nbvx=roomData.bvx, nbvy=roomData.bvy;
        if(nbvx!==0 || nbvy!==0) nbvy+=0.35; // Sadece hareket edince yerÃ§ekimi baÅŸlar
        
        const d1=Math.hypot(nbx-roomData.p1x, nby-(roomData.p1y-20));
        const d2=Math.hypot(nbx-roomData.p2x, nby-(roomData.p2y-20));
        if(d1<45){ nbvy=-11; nbvx=(nbx-roomData.p1x)*0.5; }
        if(d2<45){ nbvy=-11; nbvx=(nbx-roomData.p2x)*0.5; }
        
        if(nbx>385 && nbx<415 && nby>250){ nbvx*=-1; nbx=(nbx<400)?384:416; } // Direk
        if(nbx<15 || nbx>785) nbvx*=-1; if(nby<15) nbvy*=-1;
        
        if(nby>395){
            const s1w=nbx>400; update(ref(db,`rooms/${curRoom}`),{s1:roomData.s1+(s1w?1:0), s2:roomData.s2+(s1w?0:1), bx:s1w?600:200, by:180, bvx:0, bvy:0});
        } else {
            update(ref(db,`rooms/${curRoom}`),{bx:nbx, by:nby, bvx:nbvx, bvy:nbvy, p1x:mx, p1y:my});
        }
    } else { update(ref(db,`rooms/${curRoom}/p2x`), mx); update(ref(db,`rooms/${curRoom}/p2y`), my); }
}, 30);

function vRender(d){
    vCtx.clearRect(0,0,800,400); vCtx.fillStyle="#fff"; vCtx.fillRect(397,250,6,150);
    vCtx.fillStyle="#ff3c7a"; vCtx.beginPath(); vCtx.arc(d.p1x,d.p1y,35,Math.PI,0); vCtx.fill();
    vCtx.fillStyle="#3cff7a"; vCtx.beginPath(); vCtx.arc(d.p2x,d.p2y,35,Math.PI,0); vCtx.fill();
    vCtx.fillStyle="#f1c40f"; vCtx.beginPath(); vCtx.arc(d.bx,d.by,13,0,Math.PI*2); vCtx.fill();
}

/* --- NAV --- */
btnC.onclick=()=>{gameSelect.classList.add("hidden"); gameRoot.classList.remove("hidden");};
btnR.onclick=()=>{gameSelect.classList.add("hidden"); rplaceRoot.classList.remove("hidden"); trackRplace();};
btnV.onclick=()=>{gameSelect.classList.add("hidden"); voleybolRoot.classList.remove("hidden");};
setInterval(()=> {if(user && (userData?.paint||0)<30) runTransaction(ref(db,"users/"+user.uid+"/paint"),p=>(p||0)+1);}, 5000);
</script>
</body>
</html>
