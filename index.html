<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>OynaKral</title>
<style>
*{box-sizing:border-box}
body{margin:0;height:100vh;background:#0e0016;color:#fff;font-family:Arial;overflow:hidden;}
.hidden{display:none!important}
.center{display:flex;justify-content:center;align-items:center}
.card{background:rgba(0,0,0,.65);padding:40px;border-radius:18px;width:420px;text-align:center;}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:none;}
button{background:#7a3cff;color:#fff;font-weight:bold;cursor:pointer;}
#gameRoot{height:100vh;display:grid;grid-template-columns:220px 1fr 300px;}
#leftMenu{background:#12001f;padding:10px;display:flex;flex-direction:column;gap:10px;}
#sidePanel{padding:10px;display:flex;flex-direction:column;gap:10px;}
.panel{background:rgba(0,0,0,.5);padding:10px;border-radius:10px;}
#chatMessages{max-height:200px;overflow-y:auto;}
.popup{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;}
.popupBox{background:#1a002b;padding:25px;border-radius:18px;width:380px;text-align:center;}
#rplaceRoot{height:100vh;display:grid;grid-template-columns:180px 1fr 300px;grid-template-rows:calc(100vh - 60px) 60px;}
#rLeft{background:#12001f;padding:10px;}
#rCenter{background:#222;overflow:auto;display:flex;justify-content:center;align-items:flex-start;}
#canvasWrap{background:#eee;width:1200px;height:1200px;overflow:auto;}
#canvas{display:grid;grid-template-columns:repeat(100,12px);}
.pixel{width:12px;height:12px;background:#fff;cursor:pointer;} /* gri Ã§izgi yok */
#rChat{background:#12001f;padding:10px;display:flex;flex-direction:column;}
#rMsgs{flex:1;overflow-y:auto}
#rBottom{grid-column:1/4;background:#1a002b;display:flex;align-items:center;gap:15px;padding:10px;}
#rBottom input[type=color]{width:40px;height:40px;padding:0;border:none;}
#profileDisplay{position:absolute;top:10px;right:10px;display:flex;align-items:center;gap:10px;cursor:pointer;}
#profileDisplay img{width:40px;height:40px;border-radius:50%;border:2px solid #fff;}
#profileDisplay span{font-weight:bold;}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="center" id="authDiv">
  <div class="card">
    <h1>ğŸ‘‘ OynaKral</h1>
    <input id="username" placeholder="KullanÄ±cÄ± AdÄ±">
    <input id="password" type="password" placeholder="Åifre">
    <button id="registerBtn">KayÄ±t Ol</button>
    <button id="loginBtn">GiriÅŸ Yap</button>
    <p id="authMsg"></p>
  </div>
</div>

<!-- GAME SELECT -->
<div class="center hidden" id="gameSelect">
  <div class="card">
    <h2>ğŸ® Oyun SeÃ§</h2>
    <button id="startClicker">ğŸ–±ï¸ TÄ±klamaca</button>
    <button id="startRplace">ğŸ¨ r/place</button>
    <button id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
  </div>
  <div id="profileDisplay">
    <img id="avatar" src="https://i.pravatar.cc/40">
    <span id="profileName"></span>
  </div>
</div>

<!-- PROFÄ°L POPUP -->
<div id="profilePopup" class="popup">
  <div class="popupBox">
    <h3>ğŸ‘‘ Profil MenÃ¼sÃ¼</h3>
    <button id="profileTabBtn">Profil</button>
    <button id="nameTabBtn">AdÄ±mÄ±z</button>
    <button id="dmTabBtn">Mesajlar</button>
    <div id="profileContent" style="margin-top:15px;text-align:left;"></div>
    <button onclick="profilePopup.style.display='none'" style="margin-top:15px;">Kapat</button>
  </div>
</div>

<!-- TIKLAMACA -->
<div id="gameRoot" class="hidden">
  <div id="leftMenu">
    <button id="marketBtn">ğŸ›’ Market</button>
    <button id="casinoBtn">ğŸ° Casino</button>
    <button id="backMenuBtn">â¬… Oyun MenÃ¼sÃ¼</button>
  </div>
  <div class="center">
    <div class="card">
      <h2 id="score">AltÄ±n: 0</h2>
      <h3 id="power">TÄ±klama GÃ¼cÃ¼: 1</h3>
      <button id="clickBtn">ğŸ–±ï¸ TIKLA</button>
    </div>
  </div>
  <div id="sidePanel">
    <div class="panel">
      <h3>ğŸ† Scoreboard</h3>
      <ul id="board"></ul>
    </div>
    <div class="panel">
      <h3>ğŸ’¬ Chat</h3>
      <div id="chatMessages"></div>
      <input id="chatInput">
      <button id="sendBtn">GÃ¶nder</button>
    </div>
  </div>
</div>

<!-- MARKET -->
<div id="market" class="popup">
  <div class="popupBox">
    <h3>ğŸ›’ Market</h3>
    <p id="marketInfo"></p>
    <button id="buyPowerBtn">SATIN AL</button>
    <button onclick="market.style.display='none'">Kapat</button>
  </div>
</div>

<!-- CASINO -->
<div id="casino" class="popup">
  <div class="popupBox">
    <h3>ğŸ° YazÄ± Tura</h3>
    <input id="bet" type="number" placeholder="Bahis">
    <button onclick="coin('yazi')">YazÄ±</button>
    <button onclick="coin('tura')">Tura</button>
    <p id="coinInfo"></p>
    <button onclick="casino.style.display='none'">Kapat</button>
  </div>
</div>

<!-- RPLACE -->
<div id="rplaceRoot" class="hidden">
  <div id="rLeft">
    <button id="rBack">â¬… Oyun MenÃ¼sÃ¼</button>
    <div style="margin-top:20px;">ğŸŸ¢ Aktif Oyuncular: <span id="online">0</span></div>
  </div>
  <div id="rCenter">
    <div id="canvasWrap">
      <div id="canvas"></div>
    </div>
  </div>
  <div id="rChat">
    <h3>ğŸ’¬ r/place Chat</h3>
    <div id="rMsgs"></div>
    <input id="rInput">
    <button id="rSend">GÃ¶nder</button>
  </div>
  <div id="rBottom">
    <input type="color" id="color" value="#ff0000">
    <div>Boya: <span id="paint">30</span>/30</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase,ref,set,push,onValue,runTransaction,get,remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app=initializeApp({
  apiKey:"AIzaSyCGUe_LPKRAVz1IoqMDn-8ie9RWCrVRQLs",
  authDomain:"click-game-2de2f.firebaseapp.com",
  databaseURL:"https://click-game-2de2f-default-rtdb.firebaseio.com"
});
const auth=getAuth(app);
const db=getDatabase(app);

let user=null,userData=null;

/* ===== AUTH ===== */
registerBtn.onclick = async () => {
  const n = username.value, p = password.value;
  if (!n || !p) { authMsg.innerText="KullanÄ±cÄ± adÄ± ve ÅŸifre boÅŸ olamaz!"; return; }
  if ((await get(ref(db,"usernames/"+n))).exists()) { authMsg.innerText="KullanÄ±cÄ± zaten kayÄ±tlÄ±!"; return; }
  const c = await createUserWithEmailAndPassword(auth,n+"@oynakral.com",p);
  await set(ref(db,"users/"+c.user.uid),{username:n,score:0,power:1,price:100});
  await set(ref(db,"usernames/"+n),c.user.uid);
  authMsg.innerText="KayÄ±t baÅŸarÄ±lÄ±! ğŸ‰";
};

loginBtn.onclick = async () => {
  const email=username.value+"@oynakral.com";
  const pass=password.value;
  if(!username.value||!password.value){ authMsg.innerText="KullanÄ±cÄ± adÄ± ve ÅŸifre boÅŸ olamaz!"; return; }
  try{ await signInWithEmailAndPassword(auth,email,pass); authMsg.innerText="GiriÅŸ baÅŸarÄ±lÄ±! ğŸ‰"; } 
  catch(err){ authMsg.innerText="GiriÅŸ baÅŸarÄ±sÄ±z: "+err.message; }
};

logoutBtn.onclick=()=>signOut(auth);

/* ===== ON AUTH STATE ===== */
onAuthStateChanged(auth,u=>{
  if(!u){
    authDiv.classList.remove("hidden");
    gameSelect.classList.add("hidden");
    gameRoot.classList.add("hidden");
    rplaceRoot.classList.add("hidden");
    return;
  }

  user=u;

  get(ref(db,"bannedUsers/"+u.uid)).then(s=>{
    if(s.exists()){
      authDiv.classList.remove("hidden");
      authMsg.innerText="YasaklandÄ±nÄ±z!";
      gameSelect.classList.add("hidden");
      gameRoot.classList.add("hidden");
      rplaceRoot.classList.add("hidden");
      return;
    }
  });

  authDiv.classList.add("hidden");
  gameSelect.classList.remove("hidden");

  onValue(ref(db,"users/"+u.uid),s=>{
    userData=s.val();
    if(!userData) return;
    score.innerText="AltÄ±n: "+userData.score;
    power.innerText="TÄ±klama GÃ¼cÃ¼: "+userData.power;
    marketInfo.innerText=`GÃ¼Ã§ +1 | Fiyat ${userData.price}`;
    profileName.innerText=userData.username;
  });
});

/* ===== GAME SELECT ===== */
startClicker.onclick=()=>{gameSelect.classList.add("hidden");gameRoot.classList.remove("hidden");};
startRplace.onclick=()=>{
  gameSelect.classList.add("hidden");
  rplaceRoot.classList.remove("hidden");
  set(ref(db,"rplace/online/"+user.uid),userData.username);
};
backMenuBtn.onclick=()=>{gameRoot.classList.add("hidden");gameSelect.classList.remove("hidden");};
rBack.onclick=()=>{
  rplaceRoot.classList.add("hidden");
  gameSelect.classList.remove("hidden");
  remove(ref(db,"rplace/online/"+user.uid));
};

/* ===== CLICKER ===== */
clickBtn.onclick=()=>runTransaction(ref(db,"users/"+user.uid),d=>{d.score+=d.power;return d});
marketBtn.onclick=()=>market.style.display="flex";
buyPowerBtn.onclick=()=>runTransaction(ref(db,"users/"+user.uid),d=>{
  if(d.score<d.price)return d;
  d.score-=d.price; d.power++; d.price=Math.floor(d.price*1.1); return d;
});

/* ===== CASINO ===== */
casinoBtn.onclick=()=>casino.style.display="flex";
window.coin=(c)=>{
  const b=+bet.value;
  runTransaction(ref(db,"users/"+user.uid),d=>{
    if(d.score<b)return d;
    d.score-=b;
    const r=Math.random()<0.5?"yazi":"tura";
    if(r===c)d.score+=b*2;
    coinInfo.innerText=r===c?"KazandÄ±n":"Kaybettin";
    return d;
  });
};

/* ===== SCOREBOARD ===== */
onValue(ref(db,"users"),s=>{
  board.innerHTML="";
  Object.values(s.val()||{}).sort((a,b)=>b.score-a.score)
  .slice(0,5).forEach(u=>{
    board.innerHTML+=`<li>${u.username}: ${u.score}</li>`;
  });
});

/* ===== CHAT & KOMUTLAR ===== */
function updateChat(chatEl, chatPath){
  onValue(ref(db, chatPath), s=>{
    chatEl.innerHTML = "";
    const messages = s.val() || {};
    Object.values(messages).forEach(m=>{
      chatEl.innerHTML += `${m.user}: ${m.text}<br>`;
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  });
}
updateChat(chatMessages, "chat/tiklamaca");
updateChat(rMsgs, "chat/rplace");

function sendChat(msg, chatPath){
  if(!msg || !userData) return;

  get(ref(db, "mutedUsers/" + user.uid)).then(s=>{
    if(s.exists()) return; // susturulmuÅŸsa gÃ¶nderemez

    // remobaba komutlarÄ±
    if(userData.username === "remobaba"){
      if(msg.startsWith("/sustur ")){
        const target = msg.split(" ")[1];
        if(!target) return;
        get(ref(db,"usernames/"+target)).then(s=>{
          if(s.exists()){
            set(ref(db,"mutedUsers/"+s.val()), true);
            push(ref(db, chatPath), { user:"Sistem", text:`${target} susturuldu âœ…` });
          }
        });
        return chatInput.value="", rInput.value="";
      }
      if(msg.startsWith("/yasakla ")){
        const target = msg.split(" ")[1];
        if(!target) return;
        get(ref(db,"usernames/"+target)).then(s=>{
          if(s.exists()){
            set(ref(db,"bannedUsers/"+s.val()), true);
            push(ref(db, chatPath), { user:"Sistem", text:`${target} yasaklandÄ± âŒ` });
            if(target === userData.username) signOut(auth);
          }
        });
        return chatInput.value="", rInput.value="";
      }
      if(msg.startsWith("/affet ")){
        const target = msg.split(" ")[1];
        if(!target) return;
        get(ref(db,"usernames/"+target)).then(s=>{
          if(s.exists()){
            remove(ref(db,"mutedUsers/"+s.val()));
            remove(ref(db,"bannedUsers/"+s.val()));
            push(ref(db, chatPath), { user:"Sistem", text:`${target} affedildi âšª` });
          }
        });
        return chatInput.value="", rInput.value="";
      }
      if(msg==="/temizle"){
        remove(ref(db, chatPath));
        push(ref(db, chatPath), { user:"Sistem", text:`Sohbet temizlendi ğŸ§¹` });
        return chatInput.value="", rInput.value="";
      }
    }

    // normal mesaj
    push(ref(db, chatPath), { user: userData.username, text: msg });
    chatInput.value=""; rInput.value="";
  });
}
sendBtn.onclick = ()=>sendChat(chatInput.value, "chat/tiklamaca");
rSend.onclick   = ()=>sendChat(rInput.value, "chat/rplace");

/* ===== RPLACE ===== */
let paint=30;
const paintEl=document.getElementById("paint");
setInterval(()=>{if(paint<30){paint++;paintEl.innerText=paint}},5000);

for(let y=0;y<100;y++)for(let x=0;x<100;x++){
  const p=document.createElement("div");
  p.className="pixel";
  p.dataset.id=`${x}_${y}`;
  p.onclick=()=>{
    if(paint<=0)return;
    paint--;paintEl.innerText=paint;
    set(ref(db,"rplace/pixels/"+p.dataset.id),color.value);
  };
  canvas.appendChild(p);
}
onValue(ref(db,"rplace/pixels"),s=>{
  const d=s.val()||{};
  document.querySelectorAll(".pixel").forEach(px=>{
    if(d[px.dataset.id]) px.style.background=d[px.dataset.id];
  });
});

/* ===== RPLACE AKTÄ°F OYUNCU SAYISI ===== */
const onlineEl=document.getElementById("online");
onValue(ref(db,"rplace/online"),s=>{
  onlineEl.innerText=Object.keys(s.val()||{}).length;
});

/* ===== PROFÄ°L MENÃœSÃœ ===== */
profileDisplay.onclick = () => { profilePopup.style.display = 'flex'; };

profileTabBtn.onclick = () => {
  profileContent.innerHTML = `
    <strong>KullanÄ±cÄ± AdÄ±:</strong> ${userData.username}<br>
    <strong>AltÄ±n:</strong> ${userData.score}<br>
    <strong>TÄ±klama GÃ¼cÃ¼:</strong> ${userData.power}<br>
  `;
};
nameTabBtn.onclick = () => {
  profileContent.innerHTML = `<strong>AdÄ±mÄ±z:</strong> ${userData.username}`;
};
dmTabBtn.onclick = () => {
  profileContent.innerHTML = `
    <input id="dmTarget" placeholder="KullanÄ±cÄ± AdÄ±">
    <input id="dmMessage" placeholder="Mesaj">
    <button id="sendDMBtn">GÃ¶nder</button>
    <div id="dmStatus" style="margin-top:10px;"></div>
  `;
  document.getElementById("sendDMBtn").onclick = () => {
    const t=document.getElementById("dmTarget").value.trim();
    const m=document.getElementById("dmMessage").value.trim();
    if(!t||!m) return;
    get(ref(db,"usernames/"+t)).then(s=>{
      if(!s.exists()){ document.getElementById("dmStatus").innerText="KullanÄ±cÄ± bulunamadÄ±!"; return; }
      push(ref(db,"dm/"+s.val()),{from:userData.username,text:m});
      document.getElementById("dmStatus").innerText="Mesaj gÃ¶nderildi âœ…";
      document.getElementById("dmMessage").value="";
    });
  };
};
</script>
</body>
</html>
