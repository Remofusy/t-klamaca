<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OynaKral Pro - Performans S√ºr√ºm√º</title>
    <style>
        /* PERFORMANS ODAKLI TASARIM - G√ñLGE/BLUR YOK */
        :root { 
            --primary: #4a148c; 
            --secondary: #7b1fa2; 
            --bg: #000000; 
            --glass: #121212; 
            --border: #222; 
            --success: #1b5e20;
            --danger: #b71c1c;
            --warning: #f57f17;
        }
        
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        body { height: 100vh; background: var(--bg); color: #fff; font-family: 'Arial', sans-serif; overflow: hidden; }
        .hidden { display: none !important; }

        /* √úST DUYURU BANDI */
        #duyuruPanel { 
            position: fixed; top: 0; left: 0; right: 0; 
            background: var(--primary); padding: 12px; z-index: 99999; 
            font-weight: bold; border-bottom: 1px solid #fff; text-align: center; display: none; 
        }

        /* ANA YAPI */
        .layout { height: 100vh; display: grid; grid-template-columns: 260px 1fr 300px; }
        .sidebar { background: #0a0a0a; padding: 20px; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; }
        .sidebar-right { border-left: 1px solid var(--border); border-right: none; }

        .card { background: #111; border: 1px solid var(--border); border-radius: 4px; padding: 15px; text-align: center; }
        .chat-area { flex: 1; background: #050505; border-radius: 4px; padding: 10px; overflow-y: auto; border: 1px solid var(--border); font-size: 13px; margin-bottom: 10px; }

        /* BUTONLAR */
        .btn-pro { background: var(--primary); color: white; padding: 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .btn-pro:hover { background: var(--secondary); }
        
        /* OYUN ARA√áLARI */
        #vCanvas { background: #000; border: 1px solid var(--border); }
        #canvas { display: grid; grid-template-columns: repeat(200, 12px); width: 2400px; height: 2400px; background: #fff; image-rendering: pixelated; }
        .pixel { width: 12px; height: 12px; cursor: crosshair; }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 50000; }
        input { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid var(--border); color: #fff; border-radius: 4px; margin-bottom: 5px; }

        .admin-name { color: #ff00ff; font-weight: bold; }
        .user-name { color: #ab47bc; font-weight: bold; }
        .online-user { padding: 5px; border-bottom: 1px solid #111; font-size: 12px; color: #4caf50; }
    </style>
</head>
<body>

<div id="duyuruPanel">üì¢ <span id="duyuruMsg"></span></div>

<div id="authDiv" style="display:flex; justify-content:center; align-items:center; height:100vh;">
    <div class="card" style="width: 320px;">
        <h1 style="color:var(--secondary); margin-bottom:15px;">OynaKral</h1>
        <input id="username" placeholder="Kullanƒ±cƒ± Adƒ±">
        <input id="password" type="password" placeholder="≈ûifre">
        <button class="btn-pro" id="loginBtn" style="width:100%; margin-top:10px;">Gƒ∞Rƒ∞≈û</button>
        <button class="btn-pro" id="registerBtn" style="width:100%; margin-top:5px; background:#222;">KAYIT OL</button>
    </div>
</div>

<div id="gameSelect" class="hidden" style="display:flex; justify-content:center; align-items:center; height:100vh;">
    <div class="card" style="width: 500px;">
        <h2 style="margin-bottom:25px;">OYUN MODU SE√áƒ∞N</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
            <button class="btn-pro" id="btnC">üñ±Ô∏è TIKLA</button>
            <button class="btn-pro" id="btnR" style="background:var(--success)">üé® RPLACE</button>
            <button class="btn-pro" id="btnV" style="background:var(--warning)">üèê VOLEYBOL</button>
        </div>
        <button class="btn-pro" id="logoutBtn" style="margin-top:20px; background:#333; width:100%;">√áIKI≈û</button>
    </div>
</div>

<div id="gameRoot" class="layout hidden">
    <div class="sidebar">
        <button class="btn-pro" onclick="location.reload()">‚¨Ö MEN√ú</button>
        <div class="card">
            <small>BAKƒ∞YE</small>
            <h2 id="scoreDisp" style="color:var(--warning)">0</h2>
            <p id="powerDisp" style="font-size:11px;">G√ú√á: 1</p>
        </div>
        <button class="btn-pro" id="openMarket">üõí MARKET</button>
        <button class="btn-pro" id="openCasino">üé∞ CASINO</button>
    </div>
    <div style="display:flex; justify-content:center; align-items:center;">
        <button id="clickBtn" style="width:220px; height:220px; border-radius:50%; background:#0a0a0a; border:6px solid var(--primary); font-size:70px; cursor:pointer; color:white;">üñ±Ô∏è</button>
    </div>
    <div class="sidebar sidebar-right">
        <h3 style="text-align:center;">üèÜ Lƒ∞DERLER</h3>
        <div id="board" class="chat-area" style="max-height:140px;"></div>
        <h3 style="text-align:center;">üí¨ SOHBET</h3>
        <div class="chat-area" id="cMsgs"></div>
        <div style="display:flex; gap:5px;"><input id="cIn" placeholder="Yaz..."><button id="cSend" class="btn-pro">üöÄ</button></div>
    </div>
</div>

<div id="rplaceRoot" class="layout hidden">
    <div class="sidebar">
        <button class="btn-pro" onclick="location.reload()">‚¨Ö MEN√ú</button>
        <div class="card" style="border-color: var(--success);">
            <small>AKTƒ∞F OYUNCULAR</small>
            <h2 id="rCount">0</h2>
        </div>
        <p style="font-size:11px; color:#555; text-align:center;">OYUNCU Lƒ∞STESƒ∞</p>
        <div id="onlineList" class="chat-area" style="background:#080808;"></div>
    </div>
    <div style="overflow:auto; background:#1a1a1a;"><div id="canvas"></div></div>
    <div class="sidebar sidebar-right">
        <div class="chat-area" id="rMsgs"></div>
        <div style="display:flex; gap:5px;"><input id="rIn" placeholder="Rplace sohbet..."><button id="rSend" class="btn-pro">üöÄ</button></div>
        <div class="card" style="margin-top:10px;">
            <input type="color" id="color" value="#ff0000" style="height:45px; cursor:pointer;">
            <p style="margin-top:8px;">KALAN BOYA: <b id="paintText" style="color:var(--secondary)">30</b></p>
        </div>
    </div>
</div>

<div id="voleybolRoot" class="layout hidden">
    <div class="sidebar">
        <button class="btn-pro" onclick="location.reload()">‚¨Ö MEN√ú</button>
        <div id="vLobby">
            <button id="vCreate" class="btn-pro" style="background:var(--success); width:100%;">ODA KUR</button>
            <input id="vJoinCode" placeholder="ODA KODU" style="margin:10px 0; text-align:center;">
            <button id="vJoin" class="btn-pro" style="width:100%;">KATIL</button>
        </div>
        <div id="vInfo" class="hidden">
            <div class="card" style="background:var(--primary);">
                <small>KOD</small><h2 id="vCodeDisp">0000</h2>
            </div>
            <h1 id="vScore" style="text-align:center; margin:20px 0; font-size:40px;">0 - 0</h1>
            <div id="vPlayerList" class="chat-area" style="height:120px;"></div>
            <button id="vStart" class="btn-pro hidden" style="background:var(--success); width:100%;">BA≈ûLAT</button>
        </div>
    </div>
    <div style="display:flex; justify-content:center; align-items:center;">
        <canvas id="vCanvas" width="800" height="400" class="hidden"></canvas>
    </div>
    <div class="sidebar sidebar-right hidden" id="vChatSide">
        <div class="chat-area" id="vMsgs"></div>
        <div style="display:flex; gap:5px;"><input id="vIn" placeholder="Odaya yaz..."><button id="vSend" class="btn-pro">üöÄ</button></div>
    </div>
</div>

<div id="marketPop" class="modal">
    <div class="card" style="width:280px;">
        <h2>üõí MARKET</h2>
        <div style="margin:15px 0; padding:15px; background:#0a0a0a; border:1px solid var(--border);">
            <p>Tƒ±klama G√ºc√º +1</p>
            <b id="marketPrice" style="color:var(--warning)">100 Altƒ±n</b>
        </div>
        <button class="btn-pro" id="buyPowerBtn" style="width:100%;">SATIN AL</button>
        <button class="btn-pro" onclick="document.getElementById('marketPop').style.display='none'" style="width:100%; margin-top:8px; background:#222;">KAPAT</button>
    </div>
</div>

<div id="casinoPop" class="modal">
    <div class="card" style="width:280px;">
        <h2>üé∞ CASINO</h2>
        <input id="betAmount" type="number" placeholder="Bahis Miktarƒ±" style="margin:15px 0;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn-pro" id="betYazi">YAZI</button>
            <button class="btn-pro" id="betTura" style="background:#823100;">TURA</button>
        </div>
        <div id="casinoRes" style="margin-top:15px; font-weight:bold; height:20px;"></div>
        <button class="btn-pro" onclick="document.getElementById('casinoPop').style.display='none'" style="width:100%; margin-top:10px; background:#222;">KAPAT</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, runTransaction, get, remove, update, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCGUe_LPKRAVz1IoqMDn-8ie9RWCrVRQLs",
        authDomain: "click-game-2de2f.firebaseapp.com",
        databaseURL: "https://click-game-2de2f-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let user = null, userData = null, curRoom = null, isHost = false;
    let lastAnnID = localStorage.getItem("remobaba_p_ann");

    // --- TEMEL Sƒ∞STEM ---
    onAuthStateChanged(auth, u => {
        if (!u) { document.getElementById("authDiv").classList.remove("hidden"); return; }
        user = u;
        document.getElementById("authDiv").classList.add("hidden");
        document.getElementById("gameSelect").classList.remove("hidden");

        onValue(ref(db, "users/" + u.uid), s => {
            userData = s.val(); if(!userData) return;
            if(userData.kicked) { signOut(auth); location.reload(); }
            document.getElementById("scoreDisp").innerText = Math.floor(userData.score || 0);
            document.getElementById("powerDisp").innerText = "G√ú√á: " + (userData.power || 1);
            document.getElementById("paintText").innerText = userData.paint || 0;
            document.getElementById("marketPrice").innerText = (userData.price || 100) + " Altƒ±n";
        });

        onValue(ref(db, "global_duyuru"), s => {
            const d = s.val();
            if(d && d.id !== lastAnnID) {
                const p = document.getElementById("duyuruPanel");
                document.getElementById("duyuruMsg").innerText = d.msg;
                p.style.display = "block";
                setTimeout(() => { p.style.display="none"; lastAnnID=d.id; localStorage.setItem("remobaba_p_ann", d.id); }, 8000);
            }
        });
    });

    // --- MARKET & CASINO ---
    document.getElementById("buyPowerBtn").onclick = () => {
        runTransaction(ref(db, "users/" + user.uid), d => {
            if (d && d.score >= (d.price || 100)) {
                d.score -= (d.price || 100);
                d.power = (d.power || 1) + 1;
                d.price = Math.floor((d.price || 100) * 1.8);
            } else alert("Yetersiz altƒ±n!");
            return d;
        });
    };

    const runBet = (pick) => {
        const amt = parseInt(document.getElementById("betAmount").value);
        if(!amt || amt <= 0 || amt > userData.score) { alert("Ge√ßersiz bahis!"); return; }
        const res = Math.random() > 0.5 ? "yazi" : "tura";
        runTransaction(ref(db, "users/" + user.uid), d => {
            if(d) {
                if(pick === res) { d.score += amt; document.getElementById("casinoRes").style.color="#4caf50"; document.getElementById("casinoRes").innerText = "KAZANDIN!"; }
                else { d.score -= amt; document.getElementById("casinoRes").style.color="#f44336"; document.getElementById("casinoRes").innerText = "KAYBETTƒ∞N!"; }
            }
            return d;
        });
    };
    document.getElementById("betYazi").onclick = () => runBet("yazi");
    document.getElementById("betTura").onclick = () => runBet("tura");

    // --- VOLEYBOL ---
    document.getElementById("vCreate").onclick = () => {
        const id = Math.floor(1000 + Math.random() * 9000);
        curRoom = id; isHost = true;
        set(ref(db, `rooms/${id}`), { host: userData.username, hostId: user.uid, s1:0, s2:0, bx:400, by:200, status:"open" });
        onDisconnect(ref(db, `rooms/${id}`)).remove();
        startVoley(id);
    };

    document.getElementById("vJoin").onclick = () => {
        const id = document.getElementById("vJoinCode").value;
        get(ref(db, `rooms/${id}`)).then(s => {
            if(s.exists() && !s.val().guest) {
                curRoom = id; isHost = false;
                update(ref(db, `rooms/${id}`), { guest: userData.username, guestId: user.uid });
                startVoley(id);
            } else alert("Oda dolu veya yok!");
        });
    };

    function startVoley(id) {
        document.getElementById("vLobby").classList.add("hidden");
        document.getElementById("vInfo").classList.remove("hidden");
        document.getElementById("vCanvas").classList.remove("hidden");
        document.getElementById("vChatSide").classList.remove("hidden");
        document.getElementById("vCodeDisp").innerText = id;

        onValue(ref(db, `rooms/${id}`), s => {
            const d = s.val(); if(!d) return;
            document.getElementById("vScore").innerText = `${d.s1} - ${d.s2}`;
            document.getElementById("vPlayerList").innerHTML = `<b>P1:</b> ${d.host}<br><b>P2:</b> ${d.guest || 'Bekleniyor...'}`;
            if(isHost && d.guest) document.getElementById("vStart").classList.remove("hidden");
            
            const ctx = document.getElementById("vCanvas").getContext("2d");
            ctx.clearRect(0,0,800,400);
            ctx.fillStyle="#222"; ctx.fillRect(399, 220, 2, 180);
            ctx.fillStyle="#ffeb3b"; ctx.beginPath(); ctx.arc(d.bx, d.by, 15, 0, Math.PI*2); ctx.fill();
        });

        onValue(ref(db, `vchat/${id}`), s => {
            const el = document.getElementById("vMsgs"); el.innerHTML = "";
            if(s.exists()) Object.values(s.val()).forEach(m => el.innerHTML += `<div><b>${m.u}:</b> ${m.t}</div>`);
            el.scrollTop = el.scrollHeight;
        });
    }

    // --- GENEL SOHBET & ADMƒ∞N ---
    async function talk(inpId, path) {
        const inp = document.getElementById(inpId); const m = inp.value.trim(); if(!m) return;
        if(m.startsWith("/") && userData.username === "remobaba") {
            const parts = m.split(" "); const cmd = parts[0].toLowerCase();
            if(cmd === "/duyuru") set(ref(db, "global_duyuru"), { msg: m.replace("/duyuru","").trim(), id: Date.now().toString() });
            if(cmd === "/temizle") remove(ref(db, path));
            if(cmd === "/yasakla") {
                const sn = await get(ref(db, "users"));
                Object.keys(sn.val()).forEach(k => { if(sn.val()[k].username === parts[1]) update(ref(db, `users/${k}`), { kicked: true }); });
            }
            inp.value = ""; return;
        }
        if(userData.muted) return;
        push(ref(db, path), { u: userData.username, t: m }); inp.value = "";
    }

    // --- BUTON BAƒûLANTILARI ---
    document.getElementById("clickBtn").onclick = () => runTransaction(ref(db, "users/" + user.uid), d => { if(d) d.score += (d.power || 1); return d; });
    document.getElementById("btnC").onclick = () => { document.getElementById("gameSelect").classList.add("hidden"); document.getElementById("gameRoot").classList.remove("hidden"); };
    document.getElementById("btnV").onclick = () => { document.getElementById("gameSelect").classList.add("hidden"); document.getElementById("voleybolRoot").classList.remove("hidden"); };
    
    document.getElementById("btnR").onclick = () => { 
        document.getElementById("gameSelect").classList.add("hidden"); 
        document.getElementById("rplaceRoot").classList.remove("hidden"); 
        // Aktiflik Kaydƒ±
        const onlineRef = ref(db, "online_rplace/" + user.uid);
        set(onlineRef, { name: userData.username });
        onDisconnect(onlineRef).remove();
    };

    document.getElementById("openMarket").onclick = () => document.getElementById("marketPop").style.display="flex";
    document.getElementById("openCasino").onclick = () => document.getElementById("casinoPop").style.display="flex";
    document.getElementById("cSend").onclick = () => talk("cIn", "chat/tik");
    document.getElementById("vSend").onclick = () => talk("vIn", `vchat/${curRoom}`);
    document.getElementById("rSend").onclick = () => talk("rIn", "chat/rpl");

    // AUTH ƒ∞≈ûLEMLERƒ∞
    document.getElementById("loginBtn").onclick = () => signInWithEmailAndPassword(auth, document.getElementById("username").value+"@o.com", document.getElementById("password").value).catch(e=>alert("Hata!"));
    document.getElementById("registerBtn").onclick = async () => {
        const n = document.getElementById("username").value;
        const r = await createUserWithEmailAndPassword(auth, n+"@o.com", document.getElementById("password").value).catch(e=>alert("Hata!"));
        if(r) set(ref(db, "users/" + r.user.uid), { username: n, score: 0, power: 1, price: 100, paint: 30 });
    };

    // Lƒ∞DERLƒ∞K TABLOSU
    onValue(ref(db, "users"), s => {
        const b = document.getElementById("board"); b.innerHTML = "";
        const all = Object.values(s.val() || {}).sort((a,b) => b.score - a.score).slice(0,5);
        all.forEach((u, i) => b.innerHTML += `<div style="padding:3px; font-size:12px;">#${i+1} ${u.username}: ${Math.floor(u.score)}</div>`);
    });

    // CHAT Dƒ∞NLEME
    onValue(ref(db, "chat/tik"), s => {
        const el = document.getElementById("cMsgs"); el.innerHTML = "";
        if(s.exists()) Object.values(s.val()).forEach(m => el.innerHTML += `<div><b class="${m.u==='remobaba'?'admin-name':'user-name'}">${m.u}:</b> ${m.t}</div>`);
        el.scrollTop = el.scrollHeight;
    });

    onValue(ref(db, "chat/rpl"), s => {
        const el = document.getElementById("rMsgs"); el.innerHTML = "";
        if(s.exists()) Object.values(s.val()).forEach(m => el.innerHTML += `<div><b>${m.u}:</b> ${m.t}</div>`);
        el.scrollTop = el.scrollHeight;
    });

    // --- RPLACE AKTƒ∞F OYUNCU MOTORU (D√úZELTƒ∞LDƒ∞) ---
    onValue(ref(db, "online_rplace"), s => {
        const list = document.getElementById("onlineList");
        const countEl = document.getElementById("rCount");
        list.innerHTML = "";
        let count = 0;
        if(s.exists()) {
            Object.values(s.val()).forEach(p => {
                list.innerHTML += `<div class="online-user">‚óè ${p.name}</div>`;
                count++;
            });
        }
        countEl.innerText = count;
    });

    // RPLACE Pƒ∞KSEL MOTORU
    const canvasDiv = document.getElementById("canvas");
    for(let i=0; i<40000; i++) {
        const p = document.createElement("div"); p.className="pixel";
        p.onclick = () => { if(userData.paint > 0) { runTransaction(ref(db, `users/${user.uid}/paint`), c => (c||0)-1); set(ref(db, `rplace/pixels/${i}`), document.getElementById("color").value); } };
        canvasDiv.appendChild(p);
    }
    onValue(ref(db, "rplace/pixels"), s => { if(s.exists()) Object.keys(s.val()).forEach(k => { if(canvasDiv.children[k]) canvasDiv.children[k].style.background = s.val()[k]; }); });
    
    // Boya Dolumu
    setInterval(() => { if(user) runTransaction(ref(db, `users/${user.uid}/paint`), p => (p < 30 ? p+1 : 30)); }, 5000);
</script>
</body>
</html>
